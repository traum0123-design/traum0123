{% extends 'base.html' %}
{% block content %}
<div class="center-narrow">
  <div class="kicker">PAYROLL</div>
  <h1>{{ company_name }} · 월 선택</h1>

  <div class="card mb-14 flex-center gap-10">
    <button class="btn" data-action="changeYearPrev">◀</button>
    <strong class="fs-20 minw-120 text-center">{{ year }}년</strong>
    <button class="btn" data-action="changeYearNext">▶</button>
  </div>

  <div class="card p-16">
    <input type="hidden" id="currentYear" value="{{ year }}">
    <div class="grid-months">
      {% for m in months %}
      <a class="month-btn {{ m.state }}{% if m.is_current %} current{% endif %}"
         href="{{ url_for('portal.edit_payroll', slug=slug, year=year, month=m.month) }}" data-year="{{ year }}" data-month="{{ m.month }}" data-edit-href="{{ url_for('portal.edit_payroll', slug=slug, year=year, month=m.month) }}" data-biz-href="{{ url_for('portal.edit_bizincome', slug=slug, year=year, month=m.month) }}">
        <div class="m">{{ '%02d'|format(m.month) }}월</div>
        <div class="s">
          {% if m.state == 'closed' %}
            마감
          {% elif m.state == 'saved' %}
            저장됨
          {% elif m.state == 'none' %}
            미입력
          {% else %}
            미입력
          {% endif %}
        </div>
        <div class="u">{{ m.updated_at }}</div>
      </a>
      {% endfor %}
    </div>
    <div class="legend">
      <span class="badge b-closed">마감</span>
      <span class="badge b-saved">저장됨</span>
      <span class="badge b-none">미입력</span>
      <span class="badge b-current">현재월</span>
    </div>
  </div>
</div>

 


<!-- 근로/사업소득 선택 모달 -->
<div id="incomeSelectModal" class="modal" style="display:none;">
  <div class="card card-narrow">
    <h2>소득 유형 선택</h2>
    <p class="muted">이 월에 입력할 소득 유형을 선택하세요.</p>
    <div class="modal-actions" style="justify-content: center;">
      <button type="button" class="primary" data-action="goWage">근로소득</button>
      <button type="button" data-action="goBiz">사업소득</button>
    </div>
    <div class="mt-8" style="text-align:center;">
      <button type="button" data-action="closeModal">취소</button>
    </div>
  </div>
</div>

<script nonce="{{ csp_nonce() }}">
(function(){
  'use strict';
  const modal = document.getElementById('incomeSelectModal');
  let targetHrefEdit = null;
  let targetHrefBiz = null;

  function openModal(editHref, bizHref){
    targetHrefEdit = editHref; targetHrefBiz = bizHref;
    modal.style.display = 'flex';
  }
  function closeModal(){ modal.style.display='none'; targetHrefEdit=null; targetHrefBiz=null; }

  document.addEventListener('click', function(e){
    const a = e.target.closest('a.month-btn');
    if(a){
      e.preventDefault();
      openModal(a.getAttribute('data-edit-href'), a.getAttribute('data-biz-href'));
      return;
    }
    if(e.target && e.target.matches('[data-action="goWage"]')){
      if(targetHrefEdit){ window.location.href = targetHrefEdit; }
    }
    if(e.target && e.target.matches('[data-action="goBiz"]')){
      if(targetHrefBiz){ window.location.href = targetHrefBiz; }
    }
    if(e.target && e.target.matches('[data-action="closeModal"]')){
      closeModal();
    }
  });
})();
</script>
<script nonce="{{ csp_nonce() }}" src="{{ url_for('static', filename='portal_home.js') }}"></script>
{% endblock %}
